# Mode declaration
# 1) default: all keylib/yabaidings are available
# 2) passthrough: all keylib/yabaidings are unavailable. (If some keylib/yabaidings conflict with some application, we can turn off skhd)
# 3) prefix: a tmux style binding for moving windows
:: default : yabai -m config active_window_border_color 0xffffbb7d;\
             osascript -e "display notification \"skhd normal mode\" with title \"skhd\""

:: passthrough : yabai -m config active_window_border_color 0xff8d5524;\
                 osascript -e "display notification \"skhd passthrough mode\" with title \"skhd\""

:: prefix : yabai -m config active_window_border_color 0xff8d5524;\
                 osascript -e "display notification \"skhd prefix mode\" with title \"skhd\""

# Mode Switching
cmd - p ; passthrough
passthrough < cmd - p ; default

# Tmux style prefix
cmd - a ; prefix
prefix < cmd - a ; default


# Focus Window
#   - k, j: focus the window above or below
#   - h, l: focus the window left or right (support moving the focus across the display)
#   - r:    focus the recently-focused window
#   - <, >: cycle through the windows in the stack backward or forward
#   - /:    focus the recently-focused window in the stack
#   - m:    focus the fullscreen window in the current workspace or cycle through all the fullscreen windows
cmd - h : yabai -m window --focus west || \
            yabai -m window --focus $(yabai -m query --windows --display west | \
                jq 'map(select(.visible == 1)) | sort_by(.frame.x, .frame.y) | last | .id') || \
            yabai -m display --focus west
cmd - j : yabai -m window --focus south
cmd - k : yabai -m window --focus north
cmd - l : yabai -m window --focus east || \
            yabai -m window --focus $(yabai -m query --windows --display east | \
                jq 'map(select(.visible == 1)) | sort_by(.frame.x, .frame.y) | first | .id') || \
            yabai -m display --focus east
cmd - r : yabai -m window --focus recent
cmd - 0x2B : yabai -m window --focus stack.prev || yabai -m window --focus stack.last
cmd - 0x2F : yabai -m window --focus stack.next || yabai -m window --focus stack.first
cmd - 0x2C : yabai -m window --focus stack.recent
cmd - m : yabai -m window --toggle zoom-fullscreen
cmd + shift - m : [[ $(yabai -m query --windows --window | jq '."zoom-fullscreen"') == 0 ]] && \
          ( id=$(yabai -m query --windows --space | jq 'map(select(."zoom-fullscreen" == 1))[0] | .id') && \
            yabai -m window --focus ${id} ) || \
          ( yabai -m query --windows --space | \
            jq 'map(select(."zoom-fullscreen" == 1)) | sort_by(.id) | nth(index(map(select(.focused == 1))) - 1).id' | \
            xargs -I{} yabai -m window --focus {} )

# Focus workspace
#   - 1-0:  focus the workspace #1-#10
#   - [, ]: cycle through the workspaces (support moving the focus across the display)
#     e.g., 4 | 1 2 | 3 (three displays and currently at 2, using [ to move the focus 2 -> 1 -> 4 -> 3 -> 2, ..., ] is the same but on the opposite direction
#   - \:    focus the recently-focused workspace
####### Handled by native key bindings #######
# cmd - 0x12 : ~/.local/lib/yabai/focus-space-sip.sh 1
# cmd - 0x13 : ~/.local/lib/yabai/focus-space-sip.sh 2
# cmd - 0x14 : ~/.local/lib/yabai/focus-space-sip.sh 3
# cmd - 0x15 : ~/.local/lib/yabai/focus-space-sip.sh 4
# cmd - 0x17 : ~/.local/lib/yabai/focus-space-sip.sh 5
# cmd - 0x16 : ~/.local/lib/yabai/focus-space-sip.sh 6
# cmd - 0x1A : ~/.local/lib/yabai/focus-space-sip.sh 7
# cmd - 0x1C : ~/.local/lib/yabai/focus-space-sip.sh 8
# cmd - 0x19 : ~/.local/lib/yabai/focus-space-sip.sh 9
# cmd - 0x1D : ~/.local/lib/yabai/focus-space-sip.sh 10

cmd - 0x21 : dest=$(cur_space=$(yabai -m query --spaces --space | jq -r '.index') && yabai -m query --displays | \
             jq -r "sort_by(.frame.x) | [.[] | .spaces] | flatten | if index($cur_space) == 0 then last else .[index($cur_space) - 1] end"); \
             ~/.local/lib/yabai/focus-space-sip.sh ${dest}
cmd - 0x1E : dest=$(cur_space=$(yabai -m query --spaces --space | jq -r '.index') && yabai -m query --displays | \
             jq -r "sort_by(.frame.x) | [.[] | .spaces] | flatten | if index($cur_space) + 1 == length then first else .[index($cur_space) + 1] end"); \
             ~/.local/lib/yabai/focus-space-sip.sh ${dest}
cmd - 0x2A : recent_space=$(yabai -m query --spaces --space recent | jq '.id') && \
             ~/.local/lib/yabai/focus-space-sip.sh ${recent_space}

# Swap Window
prefix < h : yabai -m window --swap west; skhd -k "cmd - a"
prefix < j : yabai -m window --swap south; skhd -k "cmd - a"
prefix < k : yabai -m window --swap north; skhd -k "cmd - a"
prefix < l : yabai -m window --swap east; skhd -k "cmd - a"

# Move Window to Workspace and follow focus
#   - 1-0:  send the current window to the workspace #1-#10, and focus that window
#   - [, ]: send the current window to the workspace on its left or right (support sending across the display and cycling through), and focus that window
#     e.g., 4 | 1 2 | 3 (three display and currently at 3), [ will move the current window to workspace #2 and focus this window on workspace #2, and ] will move the current window to workspace #4 and focus this window on workspace #4
#   - \:    send the current window to the recently-focused workspace, and focus that window
prefix < 1 : cur_window=$(yabai -m query --windows --window | jq '.id') && \
                yabai -m window --space 1 && \
                ~/.local/lib/yabai/focus-space-sip.sh 1 && \
                yabai -m window --focus ${cur_window}; skhd -k "cmd - a"
prefix < 2 : cur_window=$(yabai -m query --windows --window | jq '.id') && \
                yabai -m window --space 2 && \
                ~/.local/lib/yabai/focus-space-sip.sh 2 && \
                yabai -m window --focus ${cur_window}; skhd -k "cmd - a"
prefix < 3 : cur_window=$(yabai -m query --windows --window | jq '.id') && \
                yabai -m window --space 3 && \
                ~/.local/lib/yabai/focus-space-sip.sh 3 && \
                yabai -m window --focus ${cur_window}; skhd -k "cmd - a"
prefix < 4 : cur_window=$(yabai -m query --windows --window | jq '.id') && \
                yabai -m window --space 4 && \
                ~/.local/lib/yabai/focus-space-sip.sh 4 && \
                yabai -m window --focus ${cur_window}; skhd -k "cmd - a"
prefix < 5 : cur_window=$(yabai -m query --windows --window | jq '.id') && \
                yabai -m window --space 5 && \
                ~/.local/lib/yabai/focus-space-sip.sh 5 && \
                yabai -m window --focus ${cur_window}; skhd -k "cmd - a"
prefix < 6 : cur_window=$(yabai -m query --windows --window | jq '.id') && \
                yabai -m window --space 6 && \
                ~/.local/lib/yabai/focus-space-sip.sh 6 && \
                yabai -m window --focus ${cur_window}; skhd -k "cmd - a"
prefix < 7 : cur_window=$(yabai -m query --windows --window | jq '.id') && \
                yabai -m window --space 7 && \
                ~/.local/lib/yabai/focus-space-sip.sh 7 && \
                yabai -m window --focus ${cur_window}; skhd -k "cmd - a"
prefix < 8 : cur_window=$(yabai -m query --windows --window | jq '.id') && \
                yabai -m window --space 8 && \
                ~/.local/lib/yabai/focus-space-sip.sh 8 && \
                yabai -m window --focus ${cur_window}; skhd -k "cmd - a"
prefix < 9 : cur_window=$(yabai -m query --windows --window | jq '.id') && \
                yabai -m window --space 9 && \
                ~/.local/lib/yabai/focus-space-sip.sh 9 && \
                yabai -m window --focus ${cur_window}; skhd -k "cmd - a"
prefix < 0 : cur_window=$(yabai -m query --windows --window | jq '.id') && \
                yabai -m window --space 10 && \
                ~/.local/lib/yabai/focus-space-sip.sh 10 && \
                yabai -m window --focus ${cur_window}; skhd -k "cmd - a"
prefix < 0x21 : cur_window=$(yabai -m query --windows --window | jq '.id') && \
                workspace_left=$(cur_space=$(yabai -m query --spaces --space | jq -r '.index') && \
                yabai -m query --displays | \
                jq -r "sort_by(.frame.x) | [.[] | .spaces] | flatten | if index($cur_space) == 0 then .[length - 1] else .[index($cur_space) - 1] end") && \
                yabai -m window --space ${workspace_left} && \
                ~/.local/lib/yabai/focus-space-sip.sh ${workspace_left} && \
                yabai -m window --focus ${cur_window}; skhd -k "cmd - a"
prefix < 0x1E : cur_window=$(yabai -m query --windows --window | jq '.id') && \
                workspace_right=$(cur_space=$(yabai -m query --spaces --space | jq -r '.index') && \
                yabai -m query --displays | \
                jq -r "sort_by(.frame.x) | [.[] | .spaces] | flatten | if index($cur_space) + 1 == length then .[0] else .[index($cur_space) + 1] end") && \
                yabai -m window --space ${workspace_right} && \
                ~/.local/lib/yabai/focus-space-sip.sh ${workspace_right} && \
                yabai -m window --focus ${cur_window}; skhd -k "cmd - a"
prefix < 0x2A : cur_window=$(yabai -m query --windows --window | jq '.id') && \
                recent_space=$(yabai -m query --spaces --space recent | jq '.id') && \
                yabai -m window --space ${recent_space} && \
                ~/.local/lib/yabai/focus-space-sip.sh ${recent_space} && \
                yabai -m window --focus ${cur_window}; skhd -k "cmd - a"


# Move Window to Workspace
#   - 1-0:  send the current window to the workspace #1-#10, and focus that window
#   - [, ]: send the current window to the workspace on its left or right (support sending across the display and cycling through), and focus that window
#     e.g., 4 | 1 2 | 3 (three display and currently at 3), [ will move the current window to workspace #2 and focus this window on workspace #2, and ] will move the current window to workspace #4 and focus this window on workspace #4
#   - \:    send the current window to the recently-focused workspace, and focus that window
prefix < ctrl - 1 : yabai -m window --space 1; skhd -k "cmd - a"
prefix < ctrl - 2 : yabai -m window --space 2; skhd -k "cmd - a"
prefix < ctrl - 3 : yabai -m window --space 3; skhd -k "cmd - a"
prefix < ctrl - 4 : yabai -m window --space 4; skhd -k "cmd - a"
prefix < ctrl - 5 : yabai -m window --space 5; skhd -k "cmd - a"
prefix < ctrl - 6 : yabai -m window --space 6; skhd -k "cmd - a"
prefix < ctrl - 7 : yabai -m window --space 7; skhd -k "cmd - a"
prefix < ctrl - 8 : yabai -m window --space 8; skhd -k "cmd - a"
prefix < ctrl - 9 : yabai -m window --space 9; skhd -k "cmd - a"
prefix < ctrl - 0 : yabai -m window --space 0; skhd -k "cmd - a"
prefix < ctrl - 0x21 : workspace_left=$(cur_space=$(yabai -m query --spaces --space | jq -r '.index') && yabai -m query --displays | \
                       jq -r "sort_by(.frame.x) | [.[] | .spaces] | flatten | if index($cur_space) == 0 then .[length - 1] else .[index($cur_space) - 1] end") && \
                       yabai -m window --space ${workspace_left}; skhd -k "cmd - a"
prefix < ctrl - 0x1E : workspace_right=$(cur_space=$(yabai -m query --spaces --space | jq -r '.index') && yabai -m query --displays | \
                       jq -r "sort_by(.frame.x) | [.[] | .spaces] | flatten | if index($cur_space) + 1 == length then .[0] else .[index($cur_space) + 1] end") && \
                       yabai -m window --space ${workspace_right}; skhd -k "cmd - a"
prefix < ctrl - 0x2A : recent_space=$(yabai -m query --spaces --space recent | jq '.id') && \
                       yabai -m window --space ${recent_space}; skhd -k "cmd - a"

# Resize Window
prefix < ctrl - h : yabai -m window --resize left:-20:0 || yabai -m window --resize right:-20:0
prefix < ctrl - j : yabai -m window --resize top:0:20 || yabai -m window --resize bottom:0:20
prefix < ctrl - k : yabai -m window --resize top:0:-20 || yabai -m window --resize bottom:0:-20
prefix < ctrl - l : yabai -m window --resize left:20:0 || yabai -m window --resize right:20:0

# Balance window sizes
prefix < 0x18 : yabai -m space --balance; skhd -k "cmd - a"

# Toggle window between tiling and floating, and restore its previous position when become floating
cmd - f : ~/.local/lib/yabai/toggle-window-floating.sh

# Apps

# Open Terminal
cmd - return : kitty -d ~

cmd - w : open -na firefox
cmd - 0x27 : ~/.local/lib/yabai/toggle-visibility.sh Slack || open -na slack
cmd - 0x29 : ~/.local/lib/yabai/toggle-visibility.sh zoom.us || open -na zoom.us

# close window
# cmd - q : yabai -m window --close || cur_window=$(yabai -m query --windows --window | jq '.pid') && kill -9 ${cur_window}
cmd - q [
  "kitty" ~ 
  * : yabai -m window --close
]

# restart yabai

cmd + cmd - r : \
  brew services restart yabai;\
  osascript -e "display notification \"Restarting Yabai\" with title \"Yabai\""

# restart skhd
#cmd - esc : brew services restart skhd

# Toggle Nightlight
cmd - b : \
  nightlight toggle
